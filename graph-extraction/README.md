# 🔗 Graph Extraction System

**LLM 기반 관계 그래프 분석 시스템**

명함 데이터에서 피처를 추출하고, LLM이 관계를 분석하여 시각화합니다.

---

## 🚀 빠른 시작

```bash
cd graph-extraction
npm install
npm start
```

브라우저에서 **http://localhost:3002** 접속

---

## 🎯 핵심 개념

### 왜 LLM 기반인가?

기존 규칙 기반 점수의 문제:
```
점수 = 미팅횟수 × 0.25 + 최근성 × 0.20 + ...
       ↑ 근거 없는 가중치
```

**해결**: LLM이 데이터를 종합적으로 이해하고 관계를 판단

```
피처 데이터 → LLM → 점수 + 근거 + 유형 + 개선제안
```

---

## 📊 파이프라인

```
┌─────────────────────────────────────────────────────────┐
│  1. 피처 추출                                            │
│     DB에서 30+ 피처 계산 (미팅, 메모, 선물, 채팅, Fact)    │
└─────────────────┬───────────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────────┐
│  2. 피처 필터링                                          │
│     유의미한 피처만 선별 (분산 낮은 피처 제외)             │
└─────────────────┬───────────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────────┐
│  3. 🤖 LLM 관계 분석                                     │
│     GPT-4o-mini가 각 인물과의 관계 분석                   │
│     → 점수, 등급, 유형, 근거, 강점, 개선점                │
└─────────────────┬───────────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────────┐
│  4. 🔄 품질 평가 & 피드백 루프                            │
│     분석 품질이 낮으면? (모두 비슷한 점수 등)             │
│     → LLM이 피처 조작 전략 제안                          │
│     → 피처 조작 실행 (CREATE, TRANSFORM, COMBINE 등)     │
│     → 재분석 (최대 3회 반복)                             │
└─────────────────┬───────────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────────┐
│  5. 🎨 그래프 시각화                                     │
│     D3.js Force-Directed Graph + 동적 애니메이션         │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 피드백 루프 상세

**문제**: "모든 사람이 비슷해서 관계 구분이 어렵다"

**해결**: LLM이 자동으로 피처를 조작하고 재분석

| 조작 | 설명 | 예시 |
|------|------|------|
| **CREATE** | 새 피처 생성 | `engagement = meetings*0.3 + memos*0.4` |
| **TRANSFORM** | 값 변환 | `daysSinceLastMeeting → recency_bucket` |
| **COMBINE** | 피처 결합 | `interaction = log(meetings+1) + log(memos+1)` |
| **REMOVE** | 무의미 피처 제거 | `hasPhone (모두 동일)` 제거 |

---

## 🎨 시각화 기능

### Force-Directed 그래프

- **중심**: "나" (사용자)
- **주변**: 명함들 (점수 높을수록 가까움)
- **색상**: 등급별 (A=초록 → F=빨강)

### 동적 효과

| 효과 | 설명 |
|------|------|
| 그라데이션 | 등급별 radial gradient |
| 글로우 | 빛나는 drop-shadow |
| 펄스 링 | 호흡하는 듯한 애니메이션 |
| 호버 확대 | 마우스오버 시 1.1배 |

### 엣지 클릭 → 관계 상세 패널

엣지(선) 또는 노드를 클릭하면 슬라이드 패널에:
- 관계 점수 (대형 숫자)
- 등급 & 관계 유형
- **💡 LLM 분석 근거** (왜 이 점수인지)
- 관계의 강점
- 개선 제안

---

## 📁 폴더 구조

```
graph-extraction/
├── config.js                 # 설정
├── server.js                 # Express API 서버
├── package.json
├── lib/
│   ├── db.js                 # DB 연결
│   ├── llm-client.js         # LLM 통신 (axios, fact-extraction 패턴)
│   ├── feature-extractor.js  # 피처 추출
│   ├── feature-filter.js     # 피처 필터링
│   ├── llm-relationship-analyzer.js  # 🤖 LLM 관계 분석
│   ├── llm-feedback-loop.js  # 🔄 자동 피드백 루프
│   └── graph-builder.js      # 그래프 데이터 생성
└── public/
    └── index.html            # 시각화 UI (D3.js)
```

---

## 🔌 API Endpoints

### 핵심 API

| Endpoint | 설명 |
|----------|------|
| `GET /api/llm-auto` | 🔄 **자동 피드백 루프** (핵심!) |
| `GET /api/llm-analyze/:cardId` | 단일 카드 LLM 분석 |
| `GET /api/llm-analyze` | 여러 카드 일괄 분석 |
| `GET /api/llm-graph` | LLM 분석 결과로 그래프 |

### 피처 관련

| Endpoint | 설명 |
|----------|------|
| `GET /api/features` | 모든 피처 추출 |
| `GET /api/features/:cardId` | 특정 카드 피처 |
| `GET /api/llm-data/:cardId` | LLM용 핵심 데이터 |
| `GET /api/filter` | 유의미 피처 필터링 |

### 쿼리 파라미터

```
/api/llm-auto?limit=30&maxIterations=3
              ↑ 분석할 카드 수  ↑ 최대 반복 횟수
```

---

## 🤖 LLM 분석 결과 예시

```json
{
  "relationshipScore": 78,
  "relationshipType": "비즈니스",
  "grade": "B",
  "summary": "프로젝트 협업을 통해 신뢰가 쌓인 비즈니스 파트너",
  "reasoning": "최근 3개월간 5회 미팅, 선물 교환 있음, 메모에서 긍정적 피드백 다수",
  "strengths": ["정기적 미팅", "상호 존중", "전문적 협력"],
  "improvements": ["비공식적 교류 늘리기", "개인적 관심사 파악"]
}
```

---

## 🎨 등급 & 관계 유형

### 등급

| 등급 | 점수 | 설명 | 색상 |
|------|------|------|------|
| A | 80-100 | 매우 친밀 | 🟢 |
| B | 60-79 | 친밀 | 🟡 |
| C | 40-59 | 보통 | 🟠 |
| D | 20-39 | 소원 | 🔴 |
| F | 0-19 | 거의 없음 | ⚫ |

### 관계 유형

- **비즈니스**: 업무 중심의 전문적 관계
- **개인적**: 친구, 지인 등 개인적 관계
- **잠재적**: 관계 발전 가능성이 있는 초기 단계
- **소원**: 연락이 뜸해진 관계
- **혼합**: 비즈니스 + 개인적 요소 혼합

---

## ⚙️ 설정 (config.js)

```javascript
// 피처 필터링 기준
featureFilter: {
  minCoefficientOfVariation: 0.3,  // CV < 0.3이면 제외 (모두 비슷)
  minDataCoverage: 0.3,            // 30% 미만만 값 있으면 제외
}

// LLM 설정
llmAnalysis: {
  model: "gpt-4o-mini",
  temperature: 0.3,
  batchDelayMs: 500,  // Rate limit 방지
}
```

---

## 💰 비용 고려

- `gpt-4o-mini` 사용 (저렴)
- `?limit=N`으로 분석 대상 제한
- 500ms 딜레이로 Rate limit 방지

---

## 🔗 관련 프로젝트

- `fact-extraction/`: Fact 추출 파이프라인 (LLM 통신 패턴 공유)
