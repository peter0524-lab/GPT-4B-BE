/**
 * LLM ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Î™®Îìà
 * OpenAI APIÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ± Î∞è fact Ï∂îÏ∂ú
 * - Í∏∞Ï°¥ ÌîÑÎ°úÏ†ùÌä∏Ïùò llm.service.js Ìå®ÌÑ¥ÏùÑ Îî∞Î¶Ñ
 */

import axios from "axios";
import { config } from "../config.js";

const LLM_TIMEOUT_MS = 300000; // 5Î∂Ñ ÌÉÄÏûÑÏïÑÏõÉ (Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±ÎüâÏù¥ ÎßéÏùÑ Îïå ÎåÄÎπÑ)

/**
 * LLMÏóê ÌÖçÏä§Ìä∏ ÏÉùÏÑ± ÏöîÏ≤≠ (OpenAI Chat API)
 * @param {string} prompt - ÌîÑÎ°¨ÌîÑÌä∏
 * @param {Object} options - ÏòµÏÖò
 * @returns {string} ÏÉùÏÑ±Îêú ÌÖçÏä§Ìä∏
 */
export const generateText = async (prompt, options = {}) => {
  if (!process.env.OPENAI_API_KEY) {
    throw new Error("OPENAI_API_KEY is not configured in .env file");
  }

  try {
    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: options.model ?? config.llm.model,
        messages: [
          {
            role: "system",
            content: options.systemPrompt || "You are a helpful assistant.",
          },
          {
            role: "user",
            content: prompt,
          },
        ],
        temperature: options.temperature ?? config.llm.temperature,
        max_tokens: options.maxTokens ?? config.llm.maxTokens,
      },
      {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
        },
        timeout: options.timeout ?? LLM_TIMEOUT_MS,
      }
    );

    if (response.data.choices && response.data.choices.length > 0) {
      return response.data.choices[0].message.content;
    }

    throw new Error("OpenAI API returned no choices");
  } catch (error) {
    if (error.response?.data?.error?.message) {
      throw new Error(`OpenAI API Error: ${error.response.data.error.message}`);
    } else if (error.message) {
      throw new Error(`OpenAI API Error: ${error.message}`);
    } else {
      throw new Error("OpenAI API Ìò∏Ï∂úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
    }
  }
};

/**
 * LLMÏóê JSON ÏÉùÏÑ± ÏöîÏ≤≠ (ÌååÏã± Ìè¨Ìï®)
 * @param {string} prompt - ÌîÑÎ°¨ÌîÑÌä∏
 * @param {Object} options - ÏòµÏÖò
 * @returns {Object} ÌååÏã±Îêú JSON
 */
export const generateJSON = async (prompt, options = {}) => {
  const text = await generateText(prompt, options);

  // JSON Î∏îÎ°ù Ï∂îÏ∂ú (```json ... ``` ÌòïÌÉú Ï≤òÎ¶¨)
  let jsonStr = text;

  const jsonMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
  if (jsonMatch) {
    jsonStr = jsonMatch[1].trim();
  } else {
    // JSON Î∞∞Ïó¥Ïù¥ÎÇò Í∞ùÏ≤¥ Ìå®ÌÑ¥ Ï∞æÍ∏∞
    const objectMatch = text.match(/(\{[\s\S]*\})/);
    const arrayMatch = text.match(/(\[[\s\S]*\])/);

    if (objectMatch) {
      jsonStr = objectMatch[1];
    } else if (arrayMatch) {
      jsonStr = arrayMatch[1];
    }
  }

  // Trailing comma Ï†úÍ±∞ (JSONÏóêÏÑú ÌóàÏö© ÏïàÎê®)
  jsonStr = jsonStr.replace(/,(\s*[\}\]])/g, '$1');
  
  try {
    return JSON.parse(jsonStr);
  } catch (e) {
    console.error("JSON ÌååÏã± Ïã§Ìå®:", e.message);
    console.error("ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ (Ïïû 300Ïûê):", text.substring(0, 300));
    console.error("ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ (ÎßàÏßÄÎßâ 200Ïûê):", text.substring(text.length - 200));
    
    // Î∂àÏôÑÏ†ÑÌïú JSON Î≥µÍµ¨ ÏãúÎèÑ
    const recoveryStrategies = [
      // Ï†ÑÎûµ 1: ÎßàÏßÄÎßâ ÏôÑÏ†ÑÌïú Î∞∞Ïó¥ ÏöîÏÜåÍπåÏßÄ ÏûêÎ•¥Í∏∞
      () => {
        // ÎßàÏßÄÎßâÏúºÎ°ú ÏôÑÏ†ÑÌûà Îã´Ìûå Í∞ùÏ≤¥ '}' Îí§Ïóê ',' ÎòêÎäî ']' Ï∞æÍ∏∞
        const patterns = [/\}\s*,\s*$/m, /\}\s*\]/g, /\]\s*,\s*$/m, /\]\s*\}/g];
        let lastSafePos = -1;
        
        for (const pattern of patterns) {
          let match;
          const testStr = jsonStr;
          pattern.lastIndex = 0;
          while ((match = pattern.exec(testStr)) !== null) {
            if (match.index > lastSafePos) {
              lastSafePos = match.index + match[0].length - 1;
            }
          }
        }
        
        if (lastSafePos > jsonStr.length / 2) {
          let fixedJson = jsonStr.substring(0, lastSafePos + 1);
          
          // Trailing comma Ï†úÍ±∞
          fixedJson = fixedJson.replace(/,(\s*[\}\]])/g, '$1');
          
          // Îã´Îäî Í¥ÑÌò∏ Ï∂îÍ∞Ä
          const openBraces = (fixedJson.match(/\{/g) || []).length;
          const closeBraces = (fixedJson.match(/\}/g) || []).length;
          const openBrackets = (fixedJson.match(/\[/g) || []).length;
          const closeBrackets = (fixedJson.match(/\]/g) || []).length;
          
          // ÏàúÏÑú Ï§ëÏöî: ] Î®ºÏ†Ä, } ÎÇòÏ§ëÏóê
          fixedJson += ']'.repeat(Math.max(0, openBrackets - closeBrackets));
          fixedJson += '}'.repeat(Math.max(0, openBraces - closeBraces));
          
          return JSON.parse(fixedJson);
        }
        return null;
      },
      // Ï†ÑÎûµ 2: Í∞Å ÏµúÏÉÅÏúÑ ÌÇ§Î≥ÑÎ°ú ÏôÑÏ†ÑÌïú Î∂ÄÎ∂ÑÎßå Ï∂îÏ∂ú
      () => {
        const result = {};
        const keyPattern = /"(business_cards|events|memos|gifts|chats)"\s*:\s*\[/g;
        let match;
        
        while ((match = keyPattern.exec(jsonStr)) !== null) {
          const key = match[1];
          const startIdx = match.index + match[0].length;
          
          // Ìï¥Îãπ Î∞∞Ïó¥Ïùò ÎÅù Ï∞æÍ∏∞
          let depth = 1;
          let endIdx = startIdx;
          for (let i = startIdx; i < jsonStr.length && depth > 0; i++) {
            if (jsonStr[i] === '[') depth++;
            else if (jsonStr[i] === ']') depth--;
            if (depth === 0) endIdx = i;
          }
          
          if (depth === 0) {
            try {
              let arrStr = '[' + jsonStr.substring(startIdx, endIdx) + ']';
              arrStr = arrStr.replace(/,(\s*[\}\]])/g, '$1');  // Trailing comma Ï†úÍ±∞
              result[key] = JSON.parse(arrStr);
            } catch {}
          } else {
            // Î∞∞Ïó¥Ïù¥ ÏûòÎ¶∞ Í≤ΩÏö∞: ÎßàÏßÄÎßâ ÏôÑÏ†ÑÌïú Í∞ùÏ≤¥ÍπåÏßÄÎßå
            const arrContent = jsonStr.substring(startIdx);
            const lastComplete = arrContent.lastIndexOf('},');
            if (lastComplete > 0) {
              try {
                let arrStr = '[' + arrContent.substring(0, lastComplete + 1) + ']';
                arrStr = arrStr.replace(/,(\s*[\}\]])/g, '$1');  // Trailing comma Ï†úÍ±∞
                result[key] = JSON.parse(arrStr);
              } catch {}
            }
          }
        }
        
        if (Object.keys(result).length > 0) {
          return result;
        }
        return null;
      }
    ];
    
    for (let i = 0; i < recoveryStrategies.length; i++) {
      try {
        console.log(`JSON Î≥µÍµ¨ ÏãúÎèÑ (Ï†ÑÎûµ ${i + 1})...`);
        const recovered = recoveryStrategies[i]();
        if (recovered) {
          console.log(`JSON Î≥µÍµ¨ ÏÑ±Í≥µ (Ï†ÑÎûµ ${i + 1})!`);
          return recovered;
        }
      } catch (recoveryError) {
        console.error(`Ï†ÑÎûµ ${i + 1} Ïã§Ìå®:`, recoveryError.message);
      }
    }
    
    throw new Error(`JSON ÌååÏã± Ïã§Ìå®: ${e.message}`);
  }
};

/**
 * ÏãúÎÇòÎ¶¨Ïò§ ÏòµÏÖò ÏÉùÏÑ± (ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌï† Ïàò ÏûàÎäî Ïó¨Îü¨ ÏãúÎÇòÎ¶¨Ïò§ Ï†úÏïà)
 * @param {string} domain - ÎèÑÎ©îÏù∏/Î∂ÑÏïº (Ïòà: "ÎπÑÏ¶àÎãàÏä§", "Í∞úÏù∏", "ÏòÅÏóÖ" Îì±)
 * @returns {Array} ÏãúÎÇòÎ¶¨Ïò§ ÏòµÏÖò Î∞∞Ïó¥
 */
export const generateScenarioOptions = async (domain = "ÎπÑÏ¶àÎãàÏä§") => {
  const prompt = `
ÎãπÏã†ÏùÄ ÎπÑÏ¶àÎãàÏä§ Í¥ÄÍ≥Ñ Í¥ÄÎ¶¨ Ïï±Ïùò ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±Í∏∞ÏûÖÎãàÎã§.
"${domain}" Î∂ÑÏïºÏóê ÎåÄÌï¥ 5Í∞úÏùò Îã§ÏñëÌïú ÏãúÎÇòÎ¶¨Ïò§ ÏòµÏÖòÏùÑ ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.

**Ï§ëÏöî**: 
- "ÎÇò" (ÏÇ¨Ïö©Ïûê/Ï£ºÏù∏Í≥µ)Ïóê ÎåÄÌïú Ï†ïÎ≥¥Îäî ÏÉùÏÑ±ÌïòÏßÄ ÎßàÏÑ∏Ïöî.
- **Î™ÖÌï® ÏàòÎäî Ï†ïÌôïÌûà 1Î™ÖÎßå!** (ÎåÄÏã† Í∑∏ 1Î™ÖÏóê ÎåÄÌï¥ ÌíçÎ∂ÄÌïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÉùÏÑ±Îê®)
- Í∑∏ 1Î™ÖÏóê ÎåÄÌïú Ï†ïÎ≥¥Î•º Îß§Ïö∞ ÏÉÅÏÑ∏ÌïòÍ≤å ÏûëÏÑ±

Í∞Å ÏãúÎÇòÎ¶¨Ïò§Îäî Îã§ÏùåÏùÑ Ìè¨Ìï®Ìï¥Ïïº Ìï©ÎãàÎã§:
1. **Ï†ïÌôïÌûà 1Î™Ö**Ïùò Í¥ÄÍ≥Ñ Ïù∏Î¨º (Ïù¥Î¶Ñ, ÏßÅÏ±Ö, ÌöåÏÇ¨)
2. Í∞Å Ïù∏Î¨ºÏùò **ÏÉÅÏÑ∏Ìïú ÌäπÏßï** (ÏÑ†Ìò∏ 2Í∞ú Ïù¥ÏÉÅ, ÎπÑÏÑ†Ìò∏/ÏïåÎ†àÎ•¥Í∏∞, Í∏∞ÎÖêÏùº 2Í∞ú Ïù¥ÏÉÅ)
3. **Îã§ÏñëÌïú ÎßåÎÇ® Ïú†Ìòï** (ÎØ∏ÌåÖ, ÏãùÏÇ¨, ÌÜµÌôî, ÌñâÏÇ¨ Îì±)
4. **Îã§ÏñëÌïú ÏÑ†Î¨º ÏÉÅÌô©** (Í∞êÏÇ¨, ÏÉùÏùº, Î™ÖÏ†à Îì±)

**‚ö†Ô∏è 5Í∞ú ÏãúÎÇòÎ¶¨Ïò§Ïùò Í¥ÄÍ≥Ñ ÍπäÏù¥Î•º Îã§ÏñëÌïòÍ≤å!**
- 1-2Í∞ú: Î∞ÄÏ†ëÌïú Í¥ÄÍ≥Ñ (ÎßåÎÇ® ÎßéÏùå, Í∞úÏù∏Ï†ïÎ≥¥ Í≥µÏú†)
- 2-3Í∞ú: Î≥¥ÌÜµ Í¥ÄÍ≥Ñ (Ï†ïÍ∏∞Ï†Å ÏóÖÎ¨¥ ÎßåÎÇ®)
- 1Í∞ú: ÌòïÏãùÏ†Å Í¥ÄÍ≥Ñ (Î™ÖÌï® ÍµêÌôò ÌõÑ Í∞ÄÎÅî Ïó∞ÎùΩ)

## Ï∂úÎ†• ÌòïÏãù
Î∞òÎìúÏãú ÏïÑÎûò JSON Î∞∞Ïó¥ ÌòïÏãùÏúºÎ°úÎßå Ï∂úÎ†•ÌïòÏÑ∏Ïöî (ÏãúÎÇòÎ¶¨Ïò§Îãπ 1Î™ÖÎßå!):

\`\`\`json
[
  {
    "id": 1,
    "title": "Ìà¨Ïûê Ïú†Ïπò Í¥ÄÍ≥Ñ Í¥ÄÎ¶¨ - Î∞ïÏÑúÏó∞ VC Ïã¨ÏÇ¨Ïó≠",
    "description": "Î∏îÎ£®Î≤§Ï≤òÏä§ VC Ïã¨ÏÇ¨Ïó≠Í≥ºÏùò Ïû•Í∏∞Ï†Å Ìà¨Ïûê Í¥ÄÍ≥Ñ Íµ¨Ï∂ï",
    "contacts": [
      {
        "name": "Î∞ïÏÑúÏó∞",
        "position": "VC Ïã¨ÏÇ¨Ïó≠",
        "company": "Î∏îÎ£®Î≤§Ï≤òÏä§",
        "gender": "Ïó¨ÏÑ±",
        "traits": [
          "Ïª§Ìîº Ï¢ãÏïÑÌï® (ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏ ÏÑ†Ìò∏)", 
          "Í≥®ÌîÑ Ï¶êÍπÄ",
          "Í≤¨Í≥ºÎ•ò ÏïåÎ†àÎ•¥Í∏∞ - Ï£ºÏùò!",
          "ÏÉùÏùº 5Ïõî 15Ïùº",
          "Í≤∞ÌòºÍ∏∞ÎÖêÏùº 11Ïõî 20Ïùº",
          "ÏïÑÏπ®Ìòï Ïù∏Í∞Ñ, Ïò§Ï†Ñ ÎØ∏ÌåÖ ÏÑ†Ìò∏",
          "ÏïÑÎì§Ïù¥ Ï¥àÎì±ÌïôÏÉù",
          "ÏôÄÏù∏ ÏàòÏßë Ï∑®ÎØ∏"
        ],
        "interactions": [
          "Ï¥àÍ∏∞ Ìà¨Ïûê ÌîºÏπ≠ ÎØ∏ÌåÖ",
          "Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏÉÅÏÑ∏ ÏÜåÍ∞ú", 
          "Ï†êÏã¨ ÏãùÏÇ¨ (ÌïúÏ†ïÏãù)",
          "Í∏∞Ïà† Îç∞Î™® ÏãúÏó∞",
          "Î∂ÑÍ∏∞Î≥Ñ ÏÑ±Í≥º Î¶¨Î∑∞",
          "ÎÑ§Ìä∏ÏõåÌÇπ ÌñâÏÇ¨ ÎèôÌñâ",
          "Ïª§Ìîº ÎØ∏ÌåÖ",
          "Ï†ÑÌôî ÌÜµÌôî"
        ],
        "gifts": [
          "Ï≤´ ÎØ∏ÌåÖ Í∞êÏÇ¨ - ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïª§ÌîºÏÑ∏Ìä∏",
          "ÏÉùÏùº ÏÑ†Î¨º - Í≥®ÌîÑÏû•Í∞ë",
          "ÏïÑÎì§ ÏÉùÏùº - Î†àÍ≥†ÏÑ∏Ìä∏",
          "Î™ÖÏ†à - ÌïúÏö∞ÏÑ∏Ìä∏ (Í≤¨Í≥ºÎ•ò Ï†úÏô∏)",
          "ÌîÑÎ°úÏ†ùÌä∏ ÏôÑÎ£å Í∞êÏÇ¨ - Í≥†Í∏â ÏôÄÏù∏",
          "Í≤∞ÌòºÍ∏∞ÎÖêÏùº - ÍΩÉÎã§Î∞ú"
        ]
      }
    ],
    "preview": "Ïû•Í∏∞Ï†Å Ìà¨Ïûê Í¥ÄÍ≥ÑÎ•º ÏåìÏïÑÍ∞ÄÎäî ÏÉÅÏÑ∏Ìïú ÏãúÎÇòÎ¶¨Ïò§"
  }
]
\`\`\`

5Í∞úÏùò ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî. Í∞Å ÏãúÎÇòÎ¶¨Ïò§Îãπ 2~3Î™ÖÏùò Ïù∏Î¨ºÎ°ú Ï†úÌïúÌïòÎêò, ÏÉÅÏÑ∏ÌïòÍ≤å ÏûëÏÑ±ÌïòÏÑ∏Ïöî.
`;

  return await generateJSON(prompt, { 
    temperature: 0.9, 
    maxTokens: 4000,
    systemPrompt: "You are a scenario generator that creates realistic business relationship scenarios. Always respond with valid JSON arrays only. Do NOT include protagonist/user information."
  });
};

/**
 * ÏãúÎÇòÎ¶¨Ïò§ Í∏∞Î∞ò ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
 * @param {string} scenario - ÏûêÏó∞Ïñ¥ ÏãúÎÇòÎ¶¨Ïò§ ÌÖçÏä§Ìä∏
 * @returns {Object} ÏÉùÏÑ±Îêú ÏõêÎ≥∏ ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞
 */
export const generateDummyData = async (scenario) => {
  const prompt = `
ÎãπÏã†ÏùÄ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±Í∏∞ÏûÖÎãàÎã§.
Îã§Ïùå ÏãúÎÇòÎ¶¨Ïò§Î•º ÏùΩÍ≥†, MySQL Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê ÏÇΩÏûÖÌï† Ïàò ÏûàÎäî JSON ÌòïÏãùÏùò Îç∞Ïù¥ÌÑ∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.

## ÏãúÎÇòÎ¶¨Ïò§
${scenario}

## Ï§ëÏöî: user_idÎäî Ìï≠ÏÉÅ 1Î°ú Í≥†Ï†ï
- ÏÉà ÏÇ¨Ïö©ÏûêÎ•º ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏäµÎãàÎã§.
- Î™®Îì† Îç∞Ïù¥ÌÑ∞Îäî Í∏∞Ï°¥ user_id = 1 Í≥ÑÏ†ïÏóê Ï∂îÍ∞ÄÎê©ÎãàÎã§.
- users ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞Îäî ÏÉùÏÑ±ÌïòÏßÄ ÎßàÏÑ∏Ïöî.

## ‚ö†Ô∏è Í¥ÄÍ≥Ñ Í∑∏ÎûòÌîÑ ÏµúÏ†ÅÌôî ÌïµÏã¨ ÏõêÏπô ‚ö†Ô∏è
**Ïù¥ Îç∞Ïù¥ÌÑ∞Îäî Í¥ÄÍ≥ÑÌòï ÎèôÏ†Å Í∑∏ÎûòÌîÑÎ•º ÏÉùÏÑ±ÌïòÎäî Îç∞ ÏÇ¨Ïö©Îê©ÎãàÎã§!**
**Î™®Îì† Î™ÖÌï®Ïù¥ Í∞ôÏùÄ "Í±∞Î¶¨(ÏπúÎ∞ÄÎèÑ)"Î•º Í∞ÄÏßÄÎ©¥ Ïïà Îê©ÎãàÎã§!**

Í¥ÄÍ≥Ñ ÍπäÏù¥(Í∑∏ÎûòÌîÑ Í±∞Î¶¨)Î•º Í≤∞Ï†ïÌïòÎäî ÏöîÏÜå:
1. **ÏÉÅÌò∏ÏûëÏö© ÎπàÎèÑ**: ÏùºÏ†ï ÏàòÍ∞Ä ÎßéÏùÑÏàòÎ°ù Í∞ÄÍπåÏö¥ Í¥ÄÍ≥Ñ
2. **ÏÉÅÌò∏ÏûëÏö© ÍπäÏù¥**: Í≥µÏãùÎØ∏ÌåÖ ‚Üí ÎπÑÍ≥µÏãùÏãùÏÇ¨ ‚Üí Í∞úÏù∏Ï†ÅÎßåÎÇ® ÏàúÏúºÎ°ú ÍπäÏñ¥Ïßê
3. **Î©îÎ™® ÏÉÅÏÑ∏Ìï®**: Í∞úÏù∏ Ï†ïÎ≥¥(Í∞ÄÏ°±, Ï∑®ÎØ∏)Î•º ÏïåÏàòÎ°ù ÏπúÎ∞ÄÌïú Í¥ÄÍ≥Ñ
4. **ÏÑ†Î¨º ÎπàÎèÑ/Í∞ÄÏπò**: ÏÑ†Î¨ºÏù¥ ÎßéÏùÑÏàòÎ°ù Ï§ëÏöîÌïú Í¥ÄÍ≥Ñ
5. **ÏãúÍ∞ÑÏ†Å ÏßÄÏÜçÏÑ±**: Ïò§Îûò Ïú†ÏßÄÎêú Í¥ÄÍ≥ÑÍ∞Ä Îçî ÍπäÏùå

**‚ö†Ô∏è Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Ï≤òÎüº ÏûêÏó∞Ïä§Îü¨Ïö¥ Í¥ÄÍ≥Ñ Îã§ÏñëÏÑ± ÌïÑÏàò!**

Ïã§Ï†ú ÎπÑÏ¶àÎãàÏä§ Í¥ÄÍ≥ÑÎäî **ÌååÎ†àÌÜ† Î≤ïÏπô**ÏùÑ Îî∞Î¶ÖÎãàÎã§:
- **80%**: ÌòïÏãùÏ†Å/Î≥¥ÌÜµ Í¥ÄÍ≥Ñ (ÏùºÏ†ï 2-3Í∞ú, Í∞ÑÎã®Ìïú ÏóÖÎ¨¥ Î©îÎ™®)
- **15%**: ÏπúÎ∞ÄÌïú Í¥ÄÍ≥Ñ (ÏùºÏ†ï 4-5Í∞ú, ÏÉÅÏÑ∏ Î©îÎ™®)
- **5%**: Î∞ÄÏ†ëÌïú Í¥ÄÍ≥Ñ (ÏùºÏ†ï 5Í∞ú+, Í∞úÏù∏Ï†ïÎ≥¥ Ìè¨Ìï® Î©îÎ™®, ÏÑ†Î¨º)

**Í¥ÄÍ≥Ñ ÍπäÏù¥Îäî Îç∞Ïù¥ÌÑ∞ ÏûêÏ≤¥Î°ú ÌëúÌòÑÌïòÏÑ∏Ïöî (Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ NO!):**
| Í¥ÄÍ≥Ñ ÍπäÏù¥ | Îç∞Ïù¥ÌÑ∞Î°ú Ïñ¥ÎñªÍ≤å ÌëúÌòÑ? |
|----------|---------------------|
| Î∞ÄÏ†ëÌï® | ÏùºÏ†ï ÎßéÏùå + Î©îÎ™®Ïóê Í∞ÄÏ°±/Ï∑®ÎØ∏ Ïñ∏Í∏â + ÎπÑÍ≥µÏãù ÎßåÎÇ®(ÏãùÏÇ¨,Ïª§Ìîº) + ÏÑ†Î¨º ÏûàÏùå |
| Î≥¥ÌÜµ | ÏùºÏ†ï Ï†ÅÎãπ + ÏóÖÎ¨¥ Î©îÎ™®Îßå + Í≥µÏãù ÎØ∏ÌåÖ ÏúÑÏ£º |
| ÌòïÏãùÏ†Å | ÏùºÏ†ï Ï†ÅÏùå + Í∞ÑÎã® Î©îÎ™® + Ï≤´ ÎØ∏ÌåÖ ÌõÑ ÌõÑÏÜç ÏóÜÏùå |

**‚ö†Ô∏è ÎÖ∏Í≥®Ï†ÅÏù∏ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞(relationship_strength Îì±)Îäî Ï†àÎåÄ ÏÉùÏÑ±ÌïòÏßÄ ÎßàÏÑ∏Ïöî!**
Ïã§Ï†ú ÏÇ¨Ïö©ÏûêÍ∞Ä ÎÇ®Í∏∞ÏßÄ ÏïäÏùÑ Îç∞Ïù¥ÌÑ∞Îäî ÏÉùÏÑ±ÌïòÎ©¥ Ïïà Îê©ÎãàÎã§.

## ÏÉùÏÑ±Ìï† ÌÖåÏù¥Î∏î Ïä§ÌÇ§Îßà (Ï§ëÏöî: Í∞Å Ïª¨Îüº ÌòïÏãùÏùÑ Ï†ïÌôïÌûà Îî∞Î•¥ÏÑ∏Ïöî)

### 1. business_cards (Î™ÖÌï® - Í¥ÄÍ≥Ñ Ïù∏Î¨ºÎì§)
- id: INT (ÏûêÎèôÏÉùÏÑ±, ÏÉùÎûµ Í∞ÄÎä•)
- userId: INT - users.id Ï∞∏Ï°∞
- name: VARCHAR(100) - Ïù∏Î¨º Ïù¥Î¶Ñ
- position: VARCHAR(100) - ÏßÅÏ±Ö
- company: VARCHAR(200) - ÌöåÏÇ¨Î™Ö
- phone: VARCHAR(50) - Ïó∞ÎùΩÏ≤ò
- email: VARCHAR(255) - Ïù¥Î©îÏùº
- memo: TEXT - ÏßßÏùÄ Î©îÎ™® (Î™ÖÌï®Ïóê Ï†ÅÎäî Í∞ÑÎã®Ìïú Î©îÎ™®)
- image: TEXT - null Í∞ÄÎä•
- design: VARCHAR(50) - Î™ÖÌï® ÎîîÏûêÏù∏ ÌÖåÎßà ("default", "modern", "classic", "minimal" Ï§ë ÌÉù1)
- isFavorite: BOOLEAN - Ï¶êÍ≤®Ï∞æÍ∏∞ Ïó¨Î∂Ä (true/false)
- gender: VARCHAR(10) - ÏÑ±Î≥Ñ ("ÎÇ®ÏÑ±", "Ïó¨ÏÑ±")
- createdAt: DATETIME - Î™ÖÌï® Îì±Î°ù ÏãúÍ∞Ñ (ÏûêÎèô Ìï†Îãπ, ÏÉùÏÑ± Í∏àÏßÄ)

### 3. events (ÏùºÏ†ï/ÎØ∏ÌåÖ) ‚ö†Ô∏è Í¥ÄÍ≥Ñ Í∑∏ÎûòÌîÑ ÌïµÏã¨ Îç∞Ïù¥ÌÑ∞! ‚ö†Ô∏è
**üîó Ïù¥ ÏùºÏ†ï Îç∞Ïù¥ÌÑ∞Îäî "ÎàÑÍ∞Ä-Ïñ∏Ï†ú-Ïñ¥Îñ§ Îß•ÎùΩÏóêÏÑú" ÎßåÎÇ¨ÎäîÏßÄÎ•º ÎÇòÌÉÄÎÇ¥Îäî Í¥ÄÍ≥Ñ Í∑∏ÎûòÌîÑÏùò ÌïµÏã¨ÏûÖÎãàÎã§!**

- id: INT (ÏûêÎèôÏÉùÏÑ±, ÏÉùÎûµ Í∞ÄÎä•)
- userId: INT - users.id Ï∞∏Ï°∞
- title: VARCHAR(200) - ÏùºÏ†ï Ï†úÎ™© **‚ö†Ô∏è Í¥ÄÍ≥ÑÏùò Îß•ÎùΩÏùÑ Î™ÖÌôïÌûà ÌëúÌòÑ!**
- startDate: DATETIME - ÏãúÏûë ÏãúÍ∞Ñ (ÏûêÎèô Ìï†Îãπ, ÏÉùÏÑ± Í∏àÏßÄ)
- endDate: DATETIME - Ï¢ÖÎ£å ÏãúÍ∞Ñ (ÏûêÎèô Ìï†Îãπ, ÏÉùÏÑ± Í∏àÏßÄ)
- category: VARCHAR(50) - Î∞òÎìúÏãú Îã§Ïùå Ï§ë ÌïòÎÇò: "ÎØ∏ÌåÖ", "ÏãùÏÇ¨", "Ï∂úÏû•", "ÌÜµÌôî", "Í∏∞ÌÉÄ"
- description: TEXT - ÏÉÅÏÑ∏ ÏÑ§Î™Ö **‚ö†Ô∏è ÎßåÎÇ®Ïùò Î™©Ï†Å, ÎÖºÏùò ÎÇ¥Ïö©, Í≤∞Í≥ºÎ•º Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú!**
- location: VARCHAR(255) - Ïû•ÏÜå **‚ö†Ô∏è Ï†ïÌôïÌïú Ïû•ÏÜåÎ™Ö (ÌöåÏÇ¨Î™Ö, Ïπ¥ÌéòÎ™Ö Îì±)**
- participants: TEXT - Ï∞∏Ïó¨Ïûê Ïù¥Î¶Ñ **‚ö†Ô∏è Îã®Ïàú Î¨∏ÏûêÏó¥Î°ú! Ïòà: "Î∞ïÏÑúÏó∞", "ÍπÄÏ≤†Ïàò, Ïù¥ÏòÅÌù¨" (Î∞∞Ïó¥ Í∏àÏßÄ!)**
- memo: TEXT - ÏùºÏ†ï Î©îÎ™® **‚ö†Ô∏è Í¥ÄÍ≥Ñ ÏßÑÏ†ÑÎèÑ, Îã§Ïùå Ïï°ÏÖò ÏïÑÏù¥ÌÖú Îì±**
- notification: INT - ÏïåÎ¶º ÏãúÍ∞Ñ (Î∂Ñ Îã®ÏúÑ, Ïòà: 30)
- isAllDay: BOOLEAN - Ï¢ÖÏùº ÏùºÏ†ï Ïó¨Î∂Ä
- linked_card_ids: VARCHAR(255) - Ïó∞Í≤∞Îêú Î™ÖÌï® IDÎì§ (ÏΩ§Îßà Íµ¨Î∂Ñ, Ïòà: "1,2,3") **‚ö†Ô∏è Í¥ÄÍ≥Ñ Í∑∏ÎûòÌîÑ Ïó∞Í≤∞ ÌïÑÏàò!**
- color: VARCHAR(20) - ÏÉâÏÉÅ ÏΩîÎìú (Ïòà: "#4285F4")
- createdAt: DATETIME - Îì±Î°ù ÏãúÍ∞Ñ (ÏûêÎèô Ìï†Îãπ, ÏÉùÏÑ± Í∏àÏßÄ)

**üéØ Í¥ÄÍ≥Ñ Í∑∏ÎûòÌîÑ ÏµúÏ†ÅÌôî ÏùºÏ†ï ÏÉùÏÑ± Í∑úÏπô:**
1. **Îã®Í≥ÑÏ†Å Í¥ÄÍ≥Ñ Î∞úÏ†Ñ**: Ï≤´ ÎØ∏ÌåÖ ‚Üí ÏóÖÎ¨¥ ÎØ∏ÌåÖ ‚Üí ÏãùÏÇ¨ ‚Üí ÎπÑÍ≥µÏãù ÎßåÎÇ® Îì± ÏûêÏó∞Ïä§Îü¨Ïö¥ ÏàúÏÑú
2. **Íµ¨Ï≤¥Ï†ÅÏù∏ Îß•ÎùΩ**: "Ìà¨Ïûê Ïú†Ïπò 1Ï∞® ÎØ∏ÌåÖ", "Í≥ÑÏïΩÏÑú Í≤ÄÌÜ† ÌöåÏùò", "ÌîÑÎ°úÏ†ùÌä∏ ÌÇ•Ïò§ÌîÑ" Îì±
3. **Í¥ÄÍ≥Ñ ÍπäÏù¥ ÌëúÌòÑ**: Ï¥àÍ∏∞Ïóî Í≥µÏãùÏ†Å, Ï†êÏ∞® ÎπÑÍ≥µÏãùÏ†Å ÎßåÎÇ®ÏúºÎ°ú Î∞úÏ†Ñ
4. **Î™ÖÌï® Ïó∞Í≤∞ ÌïÑÏàò**: linked_card_idsÎ°ú Ïñ¥Îñ§ Î™ÖÌï®Í≥º Ïó∞Í¥ÄÎêú ÏùºÏ†ïÏù∏ÏßÄ Î™ÖÌôïÌûà!

### 4. gifts (ÏÑ†Î¨º Ïù¥Î†•)
- id: INT (ÏûêÎèôÏÉùÏÑ±, ÏÉùÎûµ Í∞ÄÎä•)
- userId: INT - users.id Ï∞∏Ï°∞
- cardId: INT - business_cards.id Ï∞∏Ï°∞ (ÎàÑÍµ¨ÏóêÍ≤å Ï§¨ÎäîÏßÄ)
- giftName: VARCHAR(200) - ÏÑ†Î¨ºÎ™Ö
- giftDescription: TEXT - ÏÑ†Î¨º ÏÑ§Î™Ö
- giftImage: TEXT - null Í∞ÄÎä•
- price: INT - Í∞ÄÍ≤© (Ïà´ÏûêÎßå)
- category: VARCHAR(100) - ÏÑ†Î¨º Ïπ¥ÌÖåÍ≥†Î¶¨
- purchaseDate: DATETIME - Íµ¨Îß§/Ï†ÑÎã¨ ÎÇ†Ïßú
- occasion: VARCHAR(100) - ÏÉÅÌô© (Ïòà: "ÏÉùÏùº", "ÏäπÏßÑÏ∂ïÌïò", "Í∞êÏÇ¨", "Î™ÖÏ†à", "ÌÅ¨Î¶¨Ïä§ÎßàÏä§")
- notes: TEXT - Ï∂îÍ∞Ä Î©îÎ™®
- year: INT - Ïó∞ÎèÑ (Ïòà: 2025)
- createdAt: DATETIME - Îì±Î°ù ÏãúÍ∞Ñ (ÏûêÎèô Ìï†Îãπ, ÏÉùÏÑ± Í∏àÏßÄ)

### 5. chats (ÏÑ†Î¨º Ï∂îÏ≤ú ÎåÄÌôî)
- id: INT (ÏûêÎèôÏÉùÏÑ±, ÏÉùÎûµ Í∞ÄÎä•)
- userId: INT - users.id Ï∞∏Ï°∞
- llmProvider: VARCHAR(50) - "gpt" Í≥†Ï†ï
- title: VARCHAR(200) - ÎåÄÌôî Ï†úÎ™©
- messages: JSON - ÎåÄÌôî Î©îÏãúÏßÄ Î∞∞Ïó¥ (ÏïÑÎûò ÌòïÏãù Ï∞∏Ï°∞)
- isActive: BOOLEAN - ÌôúÏÑ± Ïó¨Î∂Ä
- createdAt: DATETIME - ÎåÄÌôî ÏãúÏûë ÏãúÍ∞Ñ

#### chats.messages ÌòïÏãù (Ï§ëÏöî! - ÏÇ¨Ïö©ÏûêÏùò ÏûêÏó∞Ïä§Îü¨Ïö¥ ÏßàÎ¨∏Ïù¥ Î®ºÏ†Ä ÎÇòÏôÄÏïº Ìï®):
[
  {"role": "user", "content": "Î∂ÄÏû•Îãò ÏïÑÎì§ ÏÉùÏùºÏù∏Îç∞ ÏÑ†Î¨º Ï∂îÏ≤úÌï¥Ï§ò. Î∂ÄÏû•ÎãòÏù¥ Ïª§Ìîº Ï¢ãÏïÑÌïòÏãúÍ≥† Í≤¨Í≥ºÎ•ò ÏïåÎ†àÎ•¥Í∏∞ ÏûàÏúºÏÖî"},
  {"role": "assistant", "content": "Îã§ÏùåÏùÄ ÏÉÅÎåÄÎ∞© Ï†ïÎ≥¥ÏûÖÎãàÎã§.\\nÏù¥Î¶Ñ: Î∞ïÏÑúÏó∞\\nÌäπÏßï: Ïª§Ìîº Ï¢ãÏïÑÌï®, Í≤¨Í≥ºÎ•ò ÏïåÎ†àÎ•¥Í∏∞\\n\\nÏ∂îÍ∞Ä Ï†ïÎ≥¥: Í∞ÄÏ°±(ÏïÑÎì§) ÏÉùÏùº ÏÑ†Î¨º Ï∂îÏ≤ú"},
  {"role": "assistant", "content": "Ï∂îÏ≤ú ÏÑ†Î¨º Î™©Î°ù:\\n1. Î†àÍ≥† Ïä§ÌÉÄÏõåÏ¶à ÏÑ∏Ìä∏ (89,000Ïõê)\\n2. ÎãåÌÖêÎèÑ Í≤åÏûÑ Ïπ¥Îìú (55,000Ïõê)\\n3. Ïä§Ìè¨Ï∏† Ïö©Ìíà ÏÑ∏Ìä∏ (65,000Ïõê)"},
  {"role": "user", "content": "ÏÑ†ÌÉùÌïú ÏÑ†Î¨º: Î†àÍ≥† Ïä§ÌÉÄÏõåÏ¶à ÏÑ∏Ìä∏"},
  {"role": "assistant", "content": "ÏÑ†Î¨ºÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!"}
]

**ÏÇ¨Ïö©Ïûê ÏßàÎ¨∏ ÏòàÏãú** (ÏûêÏó∞Ïä§Îü¨Ïö¥ Íµ¨Ïñ¥Ï≤¥Î°ú!):
- "ÍπÄÍ≥ºÏû•Îãò ÏäπÏßÑÌñàÎäîÎç∞ Î≠ê ÏÑ†Î¨ºÌïòÎ©¥ Ï¢ãÏùÑÍπå?"
- "Í±∞ÎûòÏ≤ò ÏÇ¨Ïû•Îãò Î™ÖÏ†à ÏÑ†Î¨º Ï∂îÏ≤ú Ï¢Ä"
- "ÌåÄÏû•Îãò Í≤∞ÌòºÍ∏∞ÎÖêÏùºÏù∏Îç∞ ÏôÄÏù¥ÌîÑÎ∂ÑÍªò ÎìúÎ¶¥ ÏÑ†Î¨º Î≠êÍ∞Ä Ï¢ãÏïÑ?"
- "Î∂ÄÏû•Îãò ÏïÑÎì§Ïù¥ ÎåÄÌïô Ìï©Í≤©ÌñàÎåÄ. Ï∂ïÌïò ÏÑ†Î¨º Î≠êÍ∞Ä Ï¢ãÏùÑÍπå?"
- "ÌòëÎ†•ÏÇ¨ Îã¥ÎãπÏûêÎ∂Ñ Ïù¥Î≤àÏóê Ï∂úÏÇ∞ÌïòÏÖ®ÎäîÎç∞ ÏÑ†Î¨º Ï∂îÏ≤úÌï¥Ï§ò"
- "Ï≤´ ÎØ∏ÌåÖ Í∞êÏÇ¨ ÏÑ†Î¨ºÎ°ú Î≠êÍ∞Ä Ï¢ãÏùÑÍπå? Ïª§Ìîº Ï¢ãÏïÑÌïòÏã†Îã§Í≥† ÌñàÏñ¥"

### 6. memo (ÏÉÅÏÑ∏ Î©îÎ™® - ÎØ∏ÌåÖ ÌõÑ ÌöåÍ≥†)
- id: INT (ÏûêÎèôÏÉùÏÑ±, ÏÉùÎûµ Í∞ÄÎä•)
- user_id: INT - users.id Ï∞∏Ï°∞
- business_card_id: INT - business_cards.id Ï∞∏Ï°∞
- content: TEXT - ÏÉÅÏÑ∏ Î©îÎ™® ÎÇ¥Ïö© (ÎØ∏ÌåÖ ÌõÑ Í¥ÄÏ∞∞, Ïù∏ÏÉÅ, Ìñ•ÌõÑ Í≥ÑÌöç Îì±)
- created_at: DATETIME - ÏûëÏÑ± ÏãúÍ∞Ñ (ÏûêÎèô Ìï†Îãπ, ÏÉùÏÑ± Í∏àÏßÄ)
- updated_at: DATETIME - ÏàòÏ†ï ÏãúÍ∞Ñ (ÏûêÎèô Ìï†Îãπ, ÏÉùÏÑ± Í∏àÏßÄ)

## ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Îß§Ïö∞ Ï§ëÏöî: Îç∞Ïù¥ÌÑ∞ Ïñë Í∑úÏπô (Î∞òÎìúÏãú Ï§ÄÏàò!) ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
**Î™ÖÌï® ÏàòÎäî Ï†ïÌôïÌûà 1Î™ÖÎßå! ÌïòÏßÄÎßå Í∑∏ 1Î™ÖÏóê ÎåÄÌï¥ ÌíçÎ∂ÄÌïú Îç∞Ïù¥ÌÑ∞Î•º ÏÉùÏÑ±!**

### Î™ÖÌï® 1Î™ÖÏóê ÎåÄÌï¥ ÏÉùÏÑ±Ìï† Îç∞Ïù¥ÌÑ∞ (Ï†àÎåÄ Îπ†ÏßêÏóÜÏù¥!):
### üîó ÏÉùÏÑ±Ìï† Îç∞Ïù¥ÌÑ∞ ÏàòÎüâ (ÏãúÎÇòÎ¶¨Ïò§Ïùò Í¥ÄÍ≥Ñ ÍπäÏù¥Ïóê ÎßûÍ≤å ÏûêÏó∞Ïä§ÎüΩÍ≤å Ï°∞Ï†à)

| Îç∞Ïù¥ÌÑ∞ Ï¢ÖÎ•ò | ÏàòÎüâ | ÏÑ§Î™Ö |
|------------|-----|------|
| **Î©îÎ™®(memo)** | 5-6Í∞ú | ÏãúÎÇòÎ¶¨Ïò§Ïóê ÎßûÍ≤å Ï°∞Ï†à. Î∞ÄÏ†ëÌïú Í¥ÄÍ≥ÑÎ©¥ Í∞úÏù∏Ï†ïÎ≥¥ Ìè¨Ìï® |
| **ÏùºÏ†ï(events)** | 5-6Í∞ú | Í¥ÄÍ≥Ñ Î∞úÏ†Ñ Í≥ºÏ†ï ÌëúÌòÑ. Ï≤´ ÎØ∏ÌåÖ‚ÜíÏóÖÎ¨¥‚ÜíÏãùÏÇ¨ Îì± |
| **ÏÑ†Î¨º(gifts)** | 0-1Í∞ú | ÏπúÎ∞ÄÌïú Í¥ÄÍ≥ÑÎ©¥ Ìè¨Ìï®, ÌòïÏãùÏ†ÅÏù¥Î©¥ ÏÉùÎûµ |
| **Ï±ÑÌåÖ(chats)** | 0-1Í∞ú | ÏÑ†Î¨ºÏù¥ ÏûàÏùÑ ÎïåÎßå Ìè¨Ìï® |

**‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§Ïùò ÎßåÎÇ®(interactions) ÏàòÎ•º Ï∞∏Í≥†Ìï¥ÏÑú Ï†ÅÏ†àÌûà Ï°∞Ï†àÌïòÏÑ∏Ïöî!**
**‚ö†Ô∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÎòëÍ∞ôÏùÄ ÏàòÎüâÏù¥Î©¥ Ïïà Îê©ÎãàÎã§!**

**Ï±ÑÌåÖÏùÄ Î∞òÎìúÏãú ÏÇ¨Ïö©ÏûêÏùò ÏûêÏó∞Ïä§Îü¨Ïö¥ ÏßàÎ¨∏ÏúºÎ°ú ÏãúÏûë!** Ïòà:
- "Î∂ÄÏû•Îãò ÏïÑÎì§ ÏÉùÏùºÏù∏Îç∞ Î≠ê ÏÇ¨Î©¥ Ï¢ãÏùÑÍπå?"
- "Í±∞ÎûòÏ≤ò ÏÇ¨Ïû•Îãò Î™ÖÏ†à ÏÑ†Î¨º Ï∂îÏ≤ú Ï¢Ä"

**‚úÖ ÎÇ¥Ïö© ÏÉùÏÑ± Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏:**
‚úÖ Î™®Îì† Îç∞Ïù¥ÌÑ∞Ïùò ÎÇ¥Ïö©Ïù¥ ÏÑúÎ°ú Îã§Î•∏Í∞Ä?
‚úÖ ÌòÑÏã§Ï†ÅÏù¥Í≥† Íµ¨Ï≤¥Ï†ÅÏù∏ ÎÇ¥Ïö©Ïù∏Í∞Ä?  
‚úÖ ÏãúÍ∞Ñ ÌïÑÎìúÎäî ÏÉùÎûµÌñàÎäîÍ∞Ä?
‚úÖ ÌïÑÏàò ÌïÑÎìú(Ï†úÎ™©, ÏÑ§Î™Ö, Ïπ¥ÌÖåÍ≥†Î¶¨ Îì±)Îäî Ìè¨Ìï®ÌñàÎäîÍ∞Ä?

## Ï§ëÏöî ÏÉùÏÑ± Í∑úÏπô
1. **ÌíçÎ∂ÄÌïú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±**: ÏúÑ ÏµúÏÜå ÏàòÎüâÏùÑ Î∞òÎìúÏãú ÏßÄÏºúÏ£ºÏÑ∏Ïöî. Ïã§Ï†ú ÎπÑÏ¶àÎãàÏä§ Í¥ÄÍ≥ÑÏ≤òÎüº Ïò§Îûú Í∏∞Í∞Ñ ÏåìÏù∏ Îç∞Ïù¥ÌÑ∞Î•º ÏãúÎÆ¨Î†àÏù¥ÏÖòÌï©ÎãàÎã§.

2. **ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Îäî ÏûêÎèô Ìï†Îãπ**: ÏãúÍ∞Ñ Í¥ÄÎ†® ÌïÑÎìúÎäî ÏÉùÎûµÌïòÍ≥† ÎÇ¥Ïö©Îßå ÏÉùÏÑ±ÌïòÏÑ∏Ïöî. 
   - ÏãúÍ∞Ñ/ÎÇ†ÏßúÎäî ÏïåÍ≥†Î¶¨Ï¶òÏù¥ ÏûêÎèôÏúºÎ°ú Ï§ëÎ≥µ ÏóÜÏù¥ ÌòÑÏã§Ï†ÅÏúºÎ°ú Ìï†ÎãπÌï©ÎãàÎã§.
   - **ÏÉùÏÑ±ÌïòÏßÄ ÎßàÏÑ∏Ïöî**: createdAt, startDate, endDate, purchaseDate, created_at, updated_at
3. **ÌòÑÏã§Ï†ÅÏù¥Í≥† Îã§ÏñëÌïú Î©îÎ™®**: Í∞Å Î©îÎ™®Îäî ÏÑúÎ°ú Îã§Î•∏ ÏÉÅÌô©Í≥º ÎÇ¥Ïö©Ïù¥Ïñ¥Ïïº Ìï©ÎãàÎã§:
   - "Ïª§ÌîºÎ•º Ï¢ãÏïÑÌïòÏã†Îã§Í≥† ÌïòÏÖ®Ïùå. ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏ ÏÑ†Ìò∏."
   - "Ïò§Ï†Ñ ÎØ∏ÌåÖÏùÑ ÏÑ†Ìò∏ÌïòÏãúÎäî Ìé∏. 10Ïãú Ïù¥ÌõÑÎ°ú Ïû°Í∏∞."
   - "Í≤¨Í≥ºÎ•ò ÏïåÎ†àÎ•¥Í∏∞ ÏûàÏùå - ÏÑ†Î¨º ÏÑ†ÌÉù Ïãú Ï£ºÏùò!"
   - "Îã§Ïùå ÎØ∏ÌåÖÏóêÏÑú Í∏∞Ïà† Îç∞Î™® ÏöîÏ≤≠ÌïòÏã¨. PPT Ï§ÄÎπÑ ÌïÑÏöî."
   - "Ï†êÏã¨ ÏãùÏÇ¨ Ï§ë Í∞ÄÏ°± Ïù¥ÏïºÍ∏∞. ÏïÑÎì§Ïù¥ Ï¥àÎì±ÌïôÏÉù."
   - "ÏµúÍ∑º Í≥®ÌîÑÏóê Í¥ÄÏã¨ ÎßéÏúºÏã¨. Ï£ºÎßêÏóê ÎùºÏö¥Îî© ÏûêÏ£º ÌïòÏã†Îã§Í≥†."
4. **events.categoryÎäî Î∞òÎìúÏãú** "ÎØ∏ÌåÖ", "ÏãùÏÇ¨", "Ï∂úÏû•", "ÌÜµÌôî", "Í∏∞ÌÉÄ" Ï§ë ÌïòÎÇò.
5. **gifts.occasionÏùÄ Îã§ÏñëÌïòÍ≤å**: "ÏÉùÏùº", "ÏäπÏßÑÏ∂ïÌïò", "Í∞êÏÇ¨", "Î™ÖÏ†à", "ÌÅ¨Î¶¨Ïä§ÎßàÏä§", "ÌîÑÎ°úÏ†ùÌä∏ÏôÑÎ£å" Îì±.
6. **chats.messages**Îäî "Ï∂îÍ∞Ä Ï†ïÎ≥¥:" Î¨∏Íµ¨ Ìè¨Ìï®. Í∞Å Ï±ÑÌåÖÏùÄ Îã§Î•∏ ÏÉÅÌô©(ÏÉùÏùºÏÑ†Î¨º, Í∞êÏÇ¨ÏÑ†Î¨º Îì±).

## Ï∂úÎ†• ÌòïÏãù
Î∞òÎìúÏãú ÏïÑÎûò JSON ÌòïÏãùÏúºÎ°úÎßå Ï∂úÎ†•ÌïòÏÑ∏Ïöî (usersÎäî ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏùå):

\`\`\`json
{
  "business_cards": [
    {
      "name": "Î∞ïÏÑúÏó∞",
      "position": "VC Ïã¨ÏÇ¨Ïó≠",
      "company": "Î∏îÎ£®Î≤§Ï≤òÏä§",
      "phone": "010-1234-5678",
      "email": "seoyeon@bluevc.com",
      "memo": "Ïª§Ìîº Ï¢ãÏïÑÌï®, Í≤¨Í≥ºÎ•ò ÏïåÎ†àÎ•¥Í∏∞",
      "image": null,
      "design": "modern",
      "isFavorite": true,
      "gender": "Ïó¨ÏÑ±",
      // createdAtÏùÄ ÏûêÎèô Ìï†ÎãπÎê®
    }
  ],
  "events": [
    {
      "title": "Ï¥àÍ∏∞ Ìà¨Ïûê ÏÉÅÎã¥ ÎØ∏ÌåÖ", // üîó Í¥ÄÍ≥Ñ ÏãúÏûëÏ†ê
      // startDate, endDateÎäî ÏûêÎèô Ìï†ÎãπÎê®
      "category": "ÎØ∏ÌåÖ", 
      "description": "ÏãúÎ¶¨Ï¶àA Ìà¨Ïûê Í∞ÄÎä•ÏÑ± ÌÉêÏÉâ, Í∏∞ÏóÖ Í∞úÏöî ÌîÑÎ†àÏ††ÌÖåÏù¥ÏÖò, ÏÉÅÌò∏ ÏÜåÍ∞ú",
      "location": "Î∏îÎ£®Î≤§Ï≤òÏä§ Î≥∏ÏÇ¨ ÌöåÏùòÏã§ A", // Íµ¨Ï≤¥Ï†Å Ïû•ÏÜå
      "participants": "Î∞ïÏÑúÏó∞", // Ï∞∏Í∞ÄÏûê Ïù¥Î¶Ñ (Îã®Ïàú Î¨∏ÏûêÏó¥)
      "memo": "Í¥ÄÏã¨ Î≥¥ÏûÑ, Îã§Ïùå Ïã§ÏÇ¨ÏûêÎ£å Ï§ÄÎπÑ ÌïÑÏöî. Í∏∞Ïà†Î≥¥Îã§ ÏãúÏû•ÏÑ± ÏßëÏ§ë", // Í¥ÄÍ≥Ñ ÏßÑÏ†ÑÎèÑ
      "notification": 30,
      "isAllDay": false,
      "linked_card_ids": "1",
      "color": "#4285F4"
    }
  ],
  "gifts": [
    {
      "cardId": 1,
      "giftName": "ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïª§Ìîº ÏõêÎëêÏÑ∏Ìä∏",
      "giftDescription": "ÏóêÌã∞Ïò§ÌîºÏïÑ ÏòàÍ∞ÄÏ≤¥ÌîÑ Ïä§ÌéòÏÖúÌã∞ ÏõêÎëê",
      "giftImage": null,
      "price": 45000,
      "category": "ÏãùÌíà",
      // purchaseDateÎäî ÏûêÎèô Ìï†ÎãπÎê®
      "occasion": "Í∞êÏÇ¨",
      "notes": "Ï≤´ ÎØ∏ÌåÖ Í∞êÏÇ¨ ÏÑ†Î¨ºÎ°ú Ï§ÄÎπÑ",
      "year": 2025
    }
  ],
  "chats": [
    {
      "llmProvider": "gpt",
      "title": "Î∞ïÏÑúÏó∞Îãò ÏÑ†Î¨º Ï∂îÏ≤ú",
      "messages": [
        {"role": "user", "content": "Î∞ïÏÑúÏó∞ Ïã¨ÏÇ¨Ïó≠ÎãòÌïúÌÖå Ï≤´ ÎØ∏ÌåÖ Í∞êÏÇ¨ ÏÑ†Î¨º Î≠êÍ∞Ä Ï¢ãÏùÑÍπå? Ïª§Ìîº Ï¢ãÏïÑÌïòÏã†Îã§Í≥† ÌñàÏñ¥"},
        {"role": "assistant", "content": "Îã§ÏùåÏùÄ ÏÉÅÎåÄÎ∞© Ï†ïÎ≥¥ÏûÖÎãàÎã§.\\nÏù¥Î¶Ñ: Î∞ïÏÑúÏó∞\\nÏßÅÏ±Ö: VC Ïã¨ÏÇ¨Ïó≠\\nÌöåÏÇ¨: Î∏îÎ£®Î≤§Ï≤òÏä§\\nÌäπÏßï: Ïª§ÌîºÎ•º Ï¢ãÏïÑÌï®, Í≤¨Í≥ºÎ•ò ÏïåÎ†àÎ•¥Í∏∞\\n\\nÏ∂îÍ∞Ä Ï†ïÎ≥¥: Í∞êÏÇ¨ ÏÑ†Î¨º Ï∂îÏ≤ú"},
        {"role": "assistant", "content": "Ï∂îÏ≤ú ÏÑ†Î¨º Î™©Î°ù:\\n1. ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïª§Ìîº ÏõêÎëêÏÑ∏Ìä∏ (45,000Ïõê)\\n2. Í≥†Í∏â ÎÖπÏ∞®ÏÑ∏Ìä∏ (38,000Ïõê)\\n3. ÏïÑÎ°úÎßà ÎîîÌì®Ï†Ä (52,000Ïõê)"},
        {"role": "user", "content": "ÏÑ†ÌÉùÌïú ÏÑ†Î¨º: ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïª§Ìîº ÏõêÎëêÏÑ∏Ìä∏"},
        {"role": "assistant", "content": "ÏÑ†Î¨ºÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!"}
      ],
      "isActive": false,
      // createdAtÏùÄ ÏûêÎèô Ìï†ÎãπÎê®
    },
    {
      "llmProvider": "gpt",
      "title": "Î∞ïÏÑúÏó∞Îãò ÏÉùÏùº ÏÑ†Î¨º",
      "messages": [
        {"role": "user", "content": "Îã§ÏùåÏ£ºÍ∞Ä Î∞ïÏÑúÏó∞ Ïã¨ÏÇ¨Ïó≠Îãò ÏÉùÏùºÏù∏Îç∞ ÏÑ†Î¨º Ï∂îÏ≤úÌï¥Ï§ò"},
        {"role": "assistant", "content": "Îã§ÏùåÏùÄ ÏÉÅÎåÄÎ∞© Ï†ïÎ≥¥ÏûÖÎãàÎã§.\\nÏù¥Î¶Ñ: Î∞ïÏÑúÏó∞\\nÌäπÏßï: Ïª§ÌîºÎ•º Ï¢ãÏïÑÌï®, Í≤¨Í≥ºÎ•ò ÏïåÎ†àÎ•¥Í∏∞\\n\\nÏ∂îÍ∞Ä Ï†ïÎ≥¥: ÏÉùÏùº ÏÑ†Î¨º Ï∂îÏ≤ú"},
        {"role": "assistant", "content": "Ï∂îÏ≤ú ÏÑ†Î¨º Î™©Î°ù:\\n1. Ïä§ÌéòÏÖúÌã∞ ÎìúÎ¶ΩÎ∞± ÏÑ∏Ìä∏ (65,000Ïõê)\\n2. Í≥†Í∏â Ï∞® ÏÑ†Î¨ºÏÑ∏Ìä∏ (55,000Ïõê)\\n3. ÏïÑÎ°úÎßà Ï∫îÎì§ ÏÑ∏Ìä∏ (48,000Ïõê)"},
        {"role": "user", "content": "ÏÑ†ÌÉùÌïú ÏÑ†Î¨º: Ïä§ÌéòÏÖúÌã∞ ÎìúÎ¶ΩÎ∞± ÏÑ∏Ìä∏"},
        {"role": "assistant", "content": "ÏÑ†Î¨ºÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!"}
      ],
      "isActive": false,
      // createdAtÏùÄ ÏûêÎèô Ìï†ÎãπÎê®
    }
  ],
  "memo": [
    {
      "business_card_id": 1,
      "content": "Ï≤´ ÎØ∏ÌåÖÏóêÏÑú Ìà¨Ïûê Í¥ÄÏã¨ÏÇ¨Î•º ÌååÏïÖÌï®. Í∏∞Ïà† Ïä§ÌÉùÎ≥¥Îã§Îäî ÏãúÏû• Í∑úÎ™®ÏôÄ ÏÑ±Ïû•ÏÑ±Ïóê Í¥ÄÏã¨Ïù¥ ÎßéÏùå. Ïò§Ï†Ñ ÎØ∏ÌåÖÏùÑ ÏÑ†Ìò∏ÌïòÏãúÎäî Ìé∏. Îã§ÏùåÏóêÎäî MAU ÏßÄÌëú ÏûêÎ£å Ï§ÄÎπÑÌï¥Ïïº Ìï®.",
      // created_at, updated_atÏùÄ ÏûêÎèô Ìï†ÎãπÎê®
    },
    {
      "business_card_id": 1,
      "content": "ÌõÑÏÜç ÎØ∏ÌåÖÏóêÏÑú ÌåÄ Íµ¨ÏÑ±Ïóê ÎåÄÌï¥ ÏßàÎ¨∏ ÎßéÏù¥ ÌïòÏã¨. CTO Î∞±Í∑∏ÎùºÏö¥ÎìúÏóê Í¥ÄÏã¨. Îã§Ïùå ÎØ∏ÌåÖÏóê Í∏∞Ïà† Îç∞Î™® ÏöîÏ≤≠ÌïòÏã¨.",
      // created_at, updated_atÏùÄ ÏûêÎèô Ìï†ÎãπÎê®
    }
  ]
}
\`\`\`

**Ï§ëÏöî**: 
- ÏãúÎÇòÎ¶¨Ïò§Ïùò Î™®Îì† Ïù∏Î¨ºÏóê ÎåÄÌï¥ Îç∞Ïù¥ÌÑ∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.
- business_cards, events, gifts, chats, memoÏóêÏÑú userId, user_idÎäî ÏÉùÎûµÌïòÏÑ∏Ïöî (ÏÑúÎ≤ÑÏóêÏÑú ÏûêÎèô ÏÑ§Ï†ïÎê®).
- cardId, business_card_idÎäî 1Î∂ÄÌÑ∞ ÏãúÏûëÌïòÎäî ÏàúÏÑúÎ°ú ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî (Ï≤´ Î≤àÏß∏ Î™ÖÌï® = 1).
- JSONÎßå Ï∂úÎ†•ÌïòÍ≥† Îã§Î•∏ ÏÑ§Î™ÖÏùÄ Ìè¨Ìï®ÌïòÏßÄ ÎßàÏÑ∏Ïöî.
`;

  return await generateJSON(prompt, { 
    temperature: 0.7, 
    maxTokens: 16000,  // Ï†ÅÏ†àÌïú ÌÜ†ÌÅ∞ Ïàò
    systemPrompt: "You are a database test data generator. Generate realistic, coherent data based on scenarios. IMPORTANT: Generate data according to the relationship depth specified. Always respond with COMPLETE valid JSON only. No explanations, no markdown. If response might be long, prioritize completing the JSON structure."
  });
};

/**
 * source_eventÏóêÏÑú fact Ï∂îÏ∂ú (Í∏∞Ï°¥ fact Ïª®ÌÖçÏä§Ìä∏ Ìè¨Ìï®)
 * @param {Object} sourceEvent - source_event Î†àÏΩîÎìú
 * @param {Array} existingFacts - Ìï¥Îãπ card_idÏùò Í∏∞Ï°¥ fact Î™©Î°ù (optional)
 * @returns {Array} Ï∂îÏ∂úÎêú fact Î∞∞Ïó¥
 */
export const extractFacts = async (sourceEvent, existingFacts = []) => {
  // Í∏∞Ï°¥ fact Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
  let existingFactsContext = '';
  if (existingFacts && existingFacts.length > 0) {
    existingFactsContext = `
## ‚ö†Ô∏è Í∏∞Ï°¥Ïóê ÏïåÎ†§ÏßÑ Fact (Ïù¥ ÏÇ¨ÎûåÏóê ÎåÄÌï¥ Ïù¥ÎØ∏ ÌååÏïÖÎêú Ï†ïÎ≥¥)
ÏïÑÎûòÎäî Ïù¥ ÏÇ¨ÎûåÏóê ÎåÄÌï¥ **Ïù¥Ï†ÑÏóê Ï∂îÏ∂úÎêú fact**ÏûÖÎãàÎã§.
ÏÉà Ï†ïÎ≥¥Í∞Ä Í∏∞Ï°¥ factÏôÄ **Ï∂©ÎèåÌïòÍ±∞ÎÇò Î≥ÄÍ≤Ω**ÎêòÎ©¥ Î∞òÎìúÏãú Î∞òÏòÅÌïòÏÑ∏Ïöî.

${existingFacts.map(f => `- [${f.fact_type}] ${f.fact_key} (polarity: ${f.polarity}, confidence: ${f.confidence})`).join('\n')}

### Í∏∞Ï°¥ Fact Ï≤òÎ¶¨ Í∑úÏπô:
1. **Í∞ïÌôî**: ÏÉà Ï†ïÎ≥¥Í∞Ä Í∏∞Ï°¥ factÎ•º Îí∑Î∞õÏπ®ÌïòÎ©¥ ‚Üí Í∞ôÏùÄ fact_key, confidence Ïú†ÏßÄ/ÏÉÅÏäπ
2. **Î≥ÄÍ≤Ω**: Ï∑®Ìñ•/ÏÉÅÌô©Ïù¥ Î∞îÎÄåÏóàÏúºÎ©¥ ‚Üí ÏÉà fact Ï∂îÏ∂ú (Ïòà: "ÏöîÏ¶òÏùÄ Ï∞®Î•º Îçî Ï¢ãÏïÑÌï®")
3. **Î™®Ïàú**: Í∏∞Ï°¥Í≥º Î∞òÎåÄÎêòÎäî Ï†ïÎ≥¥Î©¥ ‚Üí action="INVALIDATE"Î°ú ÌëúÏãúÌïòÍ≥† ÏÉà fact Ï∂îÏ∂ú
`;
  }

  const prompt = `
ÎãπÏã†ÏùÄ ÎπÑÏ†ïÌòï ÌÖçÏä§Ìä∏ÏóêÏÑú Íµ¨Ï°∞ÌôîÎêú ÏÇ¨Ïã§(fact)ÏùÑ Ï∂îÏ∂úÌïòÎäî Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§.
${existingFactsContext}
## ÏÉà ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞
- source_type: ${sourceEvent.source_type}
- Î∞úÏÉùÏùº: ${sourceEvent.occurred_at}
- ÏõêÎ≥∏ ÌÖçÏä§Ìä∏:
${sourceEvent.raw_text}

## Ï∂îÏ∂úÌï† fact_type (8Í∞ÄÏßÄ Í≥†Ï†ï)
1. PREFERENCE - ÏÑ†Ìò∏ÌïòÎäî Í≤É (Ï¢ãÏïÑÌïòÎäî Í≤É, Í¥ÄÏã¨ÏÇ¨)
2. DISLIKE - Ïã´Ïñ¥ÌïòÎäî Í≤É, ÌîºÌïòÎäî Í≤É
3. RISK - Î¶¨Ïä§ÌÅ¨ ÏöîÏÜå (ÏïåÎ†àÎ•¥Í∏∞, Í±¥Í∞ï Î¨∏Ï†ú Îì±)
4. CONSTRAINT - Ï†úÏïΩ Ï°∞Í±¥ (ÏãúÍ∞Ñ, Ïû•ÏÜå, Î∞©Ïãù Ï†úÌïú Îì±)
5. DATE - Ï§ëÏöîÌïú ÎÇ†Ïßú (ÏÉùÏùº, Í∏∞ÎÖêÏùº Îì±)
6. ROLE_OR_ORG - Ïó≠Ìï†, ÏßÅÏ±Ö, ÏÜåÏÜç Ï°∞ÏßÅ Ï†ïÎ≥¥
7. INTERACTION - ÏÉÅÌò∏ÏûëÏö© Í∏∞Î°ù (ÎØ∏ÌåÖ, ÌÜµÌôî, Ïù¥Î≤§Ìä∏ Îì±)
8. CONTEXT - Í∏∞ÌÉÄ Îß•ÎùΩ Ï†ïÎ≥¥ (ÏÑ±Í≤©, ÌäπÏÑ±, Î∞∞Í≤Ω Îì±)

## Ï∂îÏ∂ú Í∑úÏπô
1. **Î™ÖÏãúÏ†ÅÏúºÎ°ú Ïñ∏Í∏âÎêú Í≤ÉÎßå** Ï∂îÏ∂ú (Ï∂îÎ°†/Ï∂îÏ∏° Í∏àÏßÄ)
2. Í∞Å factÏóêÎäî Î∞òÎìúÏãú ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ÏóêÏÑú Ï∂îÏ∂úÌïú **evidence** Ìè¨Ìï®
3. **confidence**Îäî 0.0 ~ 1.0 (Î™ÖÏãúÏ†ÅÏùºÏàòÎ°ù ÎÜíÍ≤å)
   - 1.0: ÏßÅÏ†ëÏ†ÅÏúºÎ°ú Ïñ∏Í∏âÎê® ("Ïª§ÌîºÎ•º Ï¢ãÏïÑÌïúÎã§")
   - 0.8: Í∞ïÌïòÍ≤å ÏïîÏãúÎê®
   - 0.5: ÏïΩÌïòÍ≤å ÏïîÏãúÎê®
4. **fact_key**Îäî Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú ÏûëÏÑ± (Ïòà: "coffee", "morning_meeting", "nut_allergy")
5. ÎØºÍ∞êÌïú Ï†ïÎ≥¥(Ï†ïÏπò, Ï¢ÖÍµê, Í±¥Í∞ïÏÉÅÏÑ∏)Îäî Ï∂îÏ∂úÌïòÏßÄ ÏïäÏùå
6. **action** ÌïÑÎìú (optional):
   - "INVALIDATE": Í∏∞Ï°¥ factÍ∞Ä Îçî Ïù¥ÏÉÅ Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå (invalidate_keyÎ°ú Î¨¥Ìö®ÌôîÌï† fact_key ÏßÄÏ†ï)

## Ï∂úÎ†• ÌòïÏãù
JSON Î∞∞Ïó¥Î°ú Ï∂úÎ†•ÌïòÏÑ∏Ïöî:

\`\`\`json
[
  {
    "fact_type": "PREFERENCE",
    "fact_key": "coffee",
    "polarity": 1,
    "confidence": 0.9,
    "evidence": "Ïª§ÌîºÎ•º Ï¢ãÏïÑÌïòÏã†Îã§Í≥† ÌïòÏÖ®Ïùå"
  },
  {
    "fact_type": "DISLIKE",
    "fact_key": "seafood",
    "polarity": -1,
    "confidence": 0.8,
    "evidence": "Ìï¥ÏÇ∞Î¨ºÏùÄ Ïã´Ïñ¥ÌïòÏã†Îã§Í≥† Ìï®"
  },
  {
    "fact_type": "DATE",
    "fact_key": "birthday",
    "polarity": 0,
    "confidence": 1.0,
    "evidence": "ÏÉùÏùºÏùÄ 5Ïõî 15Ïùº"
  }
]
\`\`\`

### polarity Í∞í Í∑úÏπô:
- **+1 (Í∏çÏ†ï/ÏÑ†Ìò∏)**: PREFERENCEÏóê Ìï¥ÎãπÌïòÎäî Í∏çÏ†ïÏ†Å ÏÇ¨Ïã§
- **-1 (Î∂ÄÏ†ï/ÏúÑÌóò)**: DISLIKE, RISKÏóê Ìï¥ÎãπÌïòÎäî Î∂ÄÏ†ïÏ†Å/ÏúÑÌóò ÏÇ¨Ïã§
- **0 (Ï§ëÎ¶Ω/Ï†ïÎ≥¥)**: DATE, ROLE_OR_ORG, INTERACTION, CONTEXT, CONSTRAINT

ÌÖçÏä§Ìä∏ÏóêÏÑú Ï∂îÏ∂ú Í∞ÄÎä•Ìïú Î™®Îì† factÎ•º Ï∂îÏ∂úÌï¥Ï£ºÏÑ∏Ïöî. Ï∂îÏ∂úÌï† factÍ∞Ä ÏóÜÏúºÎ©¥ Îπà Î∞∞Ïó¥ []ÏùÑ Î∞òÌôòÌïòÏÑ∏Ïöî.
`;

  return await generateJSON(prompt, { 
    temperature: 0.1, 
    maxTokens: 2000,
    systemPrompt: "You are a fact extraction system. Extract facts while considering existing context. Handle conflicts by marking invalidations. Return only valid JSON arrays."
  });
};

/**
 * Í∏∞Ï°¥ Î™ÖÌï®Ïóê ÎåÄÌï¥ Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
 * @param {Object} card - Í∏∞Ï°¥ Î™ÖÌï® Ï†ïÎ≥¥
 * @param {Object} existingData - Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Îç∞Ïù¥ÌÑ∞ (Ï§ëÎ≥µ Î∞©ÏßÄÏö©)
 * @returns {Object} ÏÉùÏÑ±Îêú Î©îÎ™®, ÏùºÏ†ï, ÏÑ†Î¨º, Ï±ÑÌåÖ Îç∞Ïù¥ÌÑ∞
 */
export const generateDataForExistingCard = async (card, existingData = {}) => {
  // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î¨∏ÏûêÏó¥ ÏÉùÏÑ±
  const existingMemosStr = (existingData.memos || []).length > 0 
    ? existingData.memos.map((m, i) => `  ${i + 1}. ${m}`).join('\n')
    : '  (ÏóÜÏùå)';
  const existingEventsStr = (existingData.events || []).length > 0
    ? existingData.events.map((e, i) => `  ${i + 1}. ${e}`).join('\n')
    : '  (ÏóÜÏùå)';
  const existingGiftsStr = (existingData.gifts || []).length > 0
    ? existingData.gifts.map((g, i) => `  ${i + 1}. ${g}`).join('\n')
    : '  (ÏóÜÏùå)';
  const existingChatsStr = (existingData.chats || []).length > 0
    ? existingData.chats.map((c, i) => `  ${i + 1}. ${c}`).join('\n')
    : '  (ÏóÜÏùå)';

  const prompt = `
ÎãπÏã†ÏùÄ ÎπÑÏ¶àÎãàÏä§ Í¥ÄÍ≥Ñ Í¥ÄÎ¶¨ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±Í∏∞ÏûÖÎãàÎã§.
Í∏∞Ï°¥ Î™ÖÌï®(Í¥ÄÍ≥Ñ Ïù∏Î¨º)Ïóê ÎåÄÌï¥ **ÏÉàÎ°úÏö¥** Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.

## Í∏∞Ï°¥ Î™ÖÌï® Ï†ïÎ≥¥
- Ïù¥Î¶Ñ: ${card.name}
- ÏßÅÏ±Ö: ${card.position || 'ÎØ∏ÏûÖÎ†•'}
- ÌöåÏÇ¨: ${card.company || 'ÎØ∏ÏûÖÎ†•'}
- ÏÑ±Î≥Ñ: ${card.gender || 'ÎØ∏ÏûÖÎ†•'}
- Í∏∞Ï°¥ Î©îÎ™®: ${card.memo || 'ÏóÜÏùå'}

## ‚ö†Ô∏è‚ö†Ô∏è Ï§ëÎ≥µ Î∞©ÏßÄ - Îß§Ïö∞ Ï§ëÏöî!! ‚ö†Ô∏è‚ö†Ô∏è
ÏïÑÎûòÎäî Ïù¥ÎØ∏ Ïù¥ Î™ÖÌï®Ïóê ÎåÄÌï¥ Ï°¥Ïû¨ÌïòÎäî Îç∞Ïù¥ÌÑ∞ÏûÖÎãàÎã§.
**Ï†àÎåÄÎ°ú ÎπÑÏä∑ÌïòÍ±∞ÎÇò Ï§ëÎ≥µÎêú ÎÇ¥Ïö©ÏùÑ ÏÉùÏÑ±ÌïòÏßÄ ÎßàÏÑ∏Ïöî!**
**ÏôÑÏ†ÑÌûà ÏÉàÎ°úÏö¥ ÎÇ¥Ïö©Îßå ÏÉùÏÑ±Ìï¥Ïïº Ìï©ÎãàÎã§!**

### Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Î©îÎ™® (Ï§ëÎ≥µ Í∏àÏßÄ):
${existingMemosStr}

### Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏùºÏ†ï (Ï§ëÎ≥µ Í∏àÏßÄ):
${existingEventsStr}

### Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏÑ†Î¨º (Ï§ëÎ≥µ Í∏àÏßÄ):
${existingGiftsStr}

### Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ï±ÑÌåÖ (Ï§ëÎ≥µ Í∏àÏßÄ):
${existingChatsStr}

## ‚ö†Ô∏è ÏÉùÏÑ± Í∑úÏπô (Î∞òÎìúÏãú Ï§ÄÏàò!)
ÏúÑ Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ÏôÄ **Ï§ëÎ≥µ ÏóÜÏù¥ ÏÉàÎ°≠Í≤å** ÏÉùÏÑ±:
- **memos: 5-6Í∞ú** - Í∏∞Ï°¥Í≥º Îã§Î•∏ ÏÉàÎ°úÏö¥ Í¥ÄÏ∞∞, Ïù∏ÏÉÅ, Î©îÎ™®
- **events: 5-6Í∞ú** - Í∏∞Ï°¥Í≥º Îã§Î•∏ ÏÉàÎ°úÏö¥ ÎØ∏ÌåÖ, ÏãùÏÇ¨, ÌÜµÌôî Îì±

**‚ö†Ô∏è JSON ÏôÑÏÑ±ÏùÑ ÏµúÏö∞ÏÑ†ÏúºÎ°ú! Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûòÎ¶¨ÏßÄ ÏïäÎèÑÎ°ù Ï†ÅÎãπÌïú ÏñëÎßå ÏÉùÏÑ±!**
- **gifts: Ï†ïÌôïÌûà 1Í∞ú** - Í∏∞Ï°¥Í≥º Îã§Î•∏ ÏÉàÎ°úÏö¥ ÏÉÅÌô©Ïùò ÏÑ†Î¨º
- **chats: Ï†ïÌôïÌûà 1Í∞ú** - Í∏∞Ï°¥Í≥º Îã§Î•∏ ÏÉàÎ°úÏö¥ ÏÑ†Î¨º Ï∂îÏ≤ú ÎåÄÌôî

**‚ö†Ô∏è ÏãúÍ∞Ñ ÌïÑÎìúÎäî ÏÉùÏÑ±ÌïòÏßÄ ÎßàÏÑ∏Ïöî!**
Î™®Îì† ÏãúÍ∞Ñ Í¥ÄÎ†® ÌïÑÎìú(created_at, updated_at, startDate, endDate, purchaseDate, createdAt)Îäî 
ÏïåÍ≥†Î¶¨Ï¶òÏù¥ ÏûêÎèôÏúºÎ°ú Ï§ëÎ≥µ ÏóÜÏù¥ ÌòÑÏã§Ï†ÅÏúºÎ°ú Ìï†ÎãπÌï©ÎãàÎã§.

## ‚ö†Ô∏è ÏãúÍ∞Ñ Í∑úÏπô (Îß§Ïö∞ Ï§ëÏöî! Ï§ëÎ≥µ Ï†àÎåÄ Í∏àÏßÄ!)
- **Ï†ÑÏ≤¥ Í∏∞Í∞Ñ**: 2025ÎÖÑ 9ÏõîÎ∂ÄÌÑ∞ 2026ÎÖÑ 1ÏõîÍπåÏßÄ
- **Ï§ëÎ≥µ Î∞©ÏßÄ**: Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ÏôÄ Ï†àÎåÄÎ°ú Í∞ôÏùÄ ÎÇ†Ïßú/ÏãúÍ∞Ñ ÏÇ¨Ïö© Í∏àÏßÄ!
- **ÏµúÏÜå Í∞ÑÍ≤© Í∑úÏπô**: 
  * ÏùºÏ†ïÎì§: ÏµúÏÜå 3Ïùº Ïù¥ÏÉÅ Í∞ÑÍ≤© (Ïòà: Í∏∞Ï°¥Ïóê 1/15Í∞Ä ÏûàÏúºÎ©¥ ÏÉàÎ°úÏö¥ ÏùºÏ†ïÏùÄ 1/19 Ïù¥ÌõÑ)
  * Î©îÎ™®Îì§: Í∞ÅÍ∞Å Îã§Î•∏ ÎÇ†Ïßú (Ïòà: 1/20, 2/5, 2/18, 3/2, ...)
  * ÏãúÍ∞ÑÎåÄÎèÑ Îã§ÏñëÌôî: 09:30, 14:15, 16:45, 19:20 Îì± (Ï†ïÏãú ÌîºÌïòÍ∏∞)
- **ÌòÑÏã§Ï†Å ÏàúÏÑú**: Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ïù¥ÌõÑ ÏãúÍ∞ÑÎ∂ÄÌÑ∞ ÏÉùÏÑ±
- **ÏöîÏùº/ÏãúÍ∞Ñ Î∂ÑÏÇ∞**: Ïõî~Í∏à Îã§ÏñëÌïú ÏãúÍ∞Ñ, Í∞ÄÎÅî ÌÜ†ÏöîÏùº
- **ÏãúÍ∞ÑÏàú Ï†ïÎ†¨**: ÏÉùÏÑ±Îêú Îç∞Ïù¥ÌÑ∞Î•º ÎÇ†ÏßúÏàúÏúºÎ°ú Ï†ïÎ†¨Ìï¥ÏÑú Ï∂úÎ†•

## Ï∂úÎ†• ÌòïÏãù
\`\`\`json
{
  "memos": [
    {
      "content": "Ï≤´ ÎØ∏ÌåÖÏóêÏÑú Ïª§ÌîºÎ•º Ï¢ãÏïÑÌïòÏã†Îã§Í≥† ÌïòÏÖ®Ïùå. ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏ ÏÑ†Ìò∏.",
      // created_at, updated_atÏùÄ ÏûêÎèô Ìï†ÎãπÎê®
    }
  ],
  "events": [
    {
      "title": "Ï≤´ ÎØ∏ÌåÖ",
      // startDate, endDateÎäî ÏûêÎèô Ìï†ÎãπÎê®
      "category": "ÎØ∏ÌåÖ",
      "description": "Ï≤´ ÎßåÎÇ® Î∞è ÏÜåÍ∞ú",
      "location": "Î≥∏ÏÇ¨ ÌöåÏùòÏã§",
      "participants": "${card.name}",
      "memo": "Î™ÖÌï® ÍµêÌôò",
      "notification": 30,
      "isAllDay": false,
      "color": "#4285F4"
    }
  ],
  "gifts": [
    {
      "giftName": "ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïª§ÌîºÏÑ∏Ìä∏",
      "giftDescription": "Í≥†Í∏â ÏõêÎëê ÏÑ†Î¨ºÏÑ∏Ìä∏",
      "price": 45000,
      "category": "ÏãùÌíà",
      // purchaseDateÎäî ÏûêÎèô Ìï†ÎãπÎê®
      "occasion": "Í∞êÏÇ¨",
      "notes": "Ï≤´ ÎØ∏ÌåÖ Í∞êÏÇ¨ ÏÑ†Î¨º",
      "year": 2024
    }
  ],
  "chats": [
    {
      "title": "${card.name}Îãò Í∞êÏÇ¨ ÏÑ†Î¨º Ï∂îÏ≤ú",
      "messages": [
        {"role": "user", "content": "${card.name}ÎãòÌïúÌÖå Ï≤´ ÎØ∏ÌåÖ Í∞êÏÇ¨ ÏÑ†Î¨º Î≠êÍ∞Ä Ï¢ãÏùÑÍπå?"},
        {"role": "assistant", "content": "Îã§ÏùåÏùÄ ÏÉÅÎåÄÎ∞© Ï†ïÎ≥¥ÏûÖÎãàÎã§.\\nÏù¥Î¶Ñ: ${card.name}\\n\\nÏ∂îÍ∞Ä Ï†ïÎ≥¥: Í∞êÏÇ¨ ÏÑ†Î¨º Ï∂îÏ≤ú"},
        {"role": "assistant", "content": "Ï∂îÏ≤ú ÏÑ†Î¨º:\\n1. ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïª§ÌîºÏÑ∏Ìä∏\\n2. Í≥†Í∏â Ï∞®ÏÑ∏Ìä∏"},
        {"role": "user", "content": "ÏÑ†ÌÉùÌïú ÏÑ†Î¨º: ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïª§ÌîºÏÑ∏Ìä∏"},
        {"role": "assistant", "content": "ÏÑ†Î¨ºÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!"}
      ],
      "isActive": false,
      // createdAtÏùÄ ÏûêÎèô Ìï†ÎãπÎê®
    }
  ]
}
\`\`\`

**Ï§ëÏöî**: 
- Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÌôïÌûà 6Í∞úÏî©
- events.categoryÎäî "ÎØ∏ÌåÖ", "ÏãùÏÇ¨", "Ï∂úÏû•", "ÌÜµÌôî", "Í∏∞ÌÉÄ" Ï§ë ÌïòÎÇò
- gifts.occasionÏùÄ "ÏÉùÏùº", "ÏäπÏßÑÏ∂ïÌïò", "Í∞êÏÇ¨", "Î™ÖÏ†à", "ÌÅ¨Î¶¨Ïä§ÎßàÏä§", "ÌîÑÎ°úÏ†ùÌä∏ÏôÑÎ£å" Îì± Îã§ÏñëÌïòÍ≤å
- **Ï±ÑÌåÖÏùÄ Î∞òÎìúÏãú userÏùò ÏûêÏó∞Ïä§Îü¨Ïö¥ ÏßàÎ¨∏ÏúºÎ°ú ÏãúÏûë!** Ïòà:
  - "${card.name}Îãò ÏÉùÏùº ÏÑ†Î¨º Ï∂îÏ≤úÌï¥Ï§ò"
  - "${card.name}Îãò ÏïÑÎì§Ïù¥ ÎåÄÌïô Ìï©Í≤©ÌñàÎåÄ Ï∂ïÌïò ÏÑ†Î¨º Î≠êÍ∞Ä Ï¢ãÏùÑÍπå?"
  - "Ïù¥Î≤àÏóê ${card.name}ÎãòÌïúÌÖå Î™ÖÏ†à ÏÑ†Î¨º Î≥¥ÎÇ¥Ïïº ÌïòÎäîÎç∞ Î≠êÍ∞Ä Ï¢ãÏïÑ?"
  - "${card.name}Îãò ÏäπÏßÑÌïòÏÖ®ÎäîÎç∞ Î≠ê Î≥¥ÎÇ¥Î©¥ Ï¢ãÏùÑÍπå"
- Í∏∞Ï°¥ Î™ÖÌï® Î©îÎ™®(${card.memo || 'ÏóÜÏùå'})Î•º Ï∞∏Í≥†Ìï¥ÏÑú ÌòÑÏã§Ï†ÅÏù∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
`;

  return await generateJSON(prompt, { 
    temperature: 0.7, 
    maxTokens: 6000,
    systemPrompt: "You are a business relationship data generator. Generate exactly 6 items for each category. Always respond with valid JSON only."
  });
};

// Ï¥àÍ∏∞Ìôî Ìï®Ïàò (Ìò∏ÌôòÏÑ± Ïú†ÏßÄ)
export const initLLM = () => {
  if (!process.env.OPENAI_API_KEY) {
    console.warn("‚ö†Ô∏è OPENAI_API_KEY not found in environment variables");
    return false;
  }
  console.log("‚úì LLM Client initialized (OpenAI API)");
  return true;
};
